---
title: "Quick tutorial on ggplot2"
author: "Cynthia Kineza"
date: '2017-10-11'
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=100),tidy=TRUE)
```

ggplot2 has been my most used graphical tool for all of my data analysis projects. So, I thought my first blog post would be a short tutorial on how to use it to create meaningful plots.

###ggplot2
ggplot2 is such a powerful R package for visualization. I personally admire the clarity and aesthetic of plots generated by this tool. It was created by Hadley Wickham in 2005 and is one of the best maintained R packages. 
So let's get started:

###Installation
There are three ways this can be done:

####1. By installing whole tidyverse:
install.packages("tidyverse")

####2. Install just ggplot2: This being the most used.
install.packages("ggplot2")

####3. Or the development version from GitHub:
install.packages("devtools")

devtools::install_github("tidyverse/ggplot2")

### Usage

In order to start of, you first write ggplot(), then inside supply a dataset; then use aes() which provides aesthetic mappings that describes how variables in the data are mapped to visual properties of geoms.
Then, you can start adding layers such as geom_smooth(), geom_jitter(), geom_line(), ggtitle().... , scales such as scale_linetype_manual (the code below illustrates how this allows us to add an additional element on the legend tab), and faceting specifications (you can have multiple panels based on a variable, split the plot using facets).


### Example 1:
Data collected from DAP-2016 was used to predict the association between a typical patient's emergency department "ED" LOS (length of stay until discharge or hospital admission) and factors that potentially contribute to LOS measured over a one-year period. 
```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(gridExtra)
library(grid)
library(gtable)
library(dplyr)
library(boot)
library(xtable)

emergency.data = read.csv("~/Documents/emergency room data.csv")
emergency.data = subset(emergency.data, emergency.data$los>=10)  #at least 10 minutes 

#Create variables: Shifts for hours and severity levels

emergency.data$Shift = emergency.data$tod
emergency.data$Shift[emergency.data$Shift>= 0 & emergency.data$Shift <= 6] <- 1
emergency.data$Shift[emergency.data$Shift == 23 ] <- 1
emergency.data$Shift[emergency.data$Shift >= 7 & emergency.data$Shift <= 14] <- 2
emergency.data$Shift[emergency.data$Shift >= 15 & emergency.data$Shift <= 22] <- 3

#Severity Levels
emergency.data$acuitylevels = emergency.data$acuity
emergency.data$acuitylevels[emergency.data$acuitylevels==1] <- "weak"
emergency.data$acuitylevels[emergency.data$acuitylevels== 3  | emergency.data$acuitylevels==2 ] <- "mild"
emergency.data$acuitylevels[emergency.data$acuitylevels==4 | emergency.data$acuitylevels==5 ] <- "severe"

#age subset

emergency.data = subset(emergency.data,emergency.data$age >=18 & emergency.data$age <= 88 )

#distinguish weekdays to weekends; here weekends are coded 1 while weekdays are coded 0
emergency.data$typeofday = ifelse(emergency.data$weekd==1 | emergency.data$weekd==7,1,0)

### More changes on the dataset 
emergency.data$ageat40 = emergency.data$age - 40
emergency.data$daydistinct = (emergency.data$typeofday==0)
emergency.data$acuity_chosen = ifelse(emergency.data$acuitylevels=="mild" | emergency.data$acuitylevels=="weak",0,1)

#Lets have two splines at 20 and 40 
emergency.data$agespline40 = ifelse(emergency.data$age - 40 >0, emergency.data$age - 40,0)
### see people get more sick on weekdays or weekends######
sick.1 = subset(emergency.data,emergency.data$typeofday==1)
sick.2 = subset(emergency.data,emergency.data$typeofday==0)
```

For better graphical representation, we make some adjustments to create categorical variables. 
Therefore, I divided time of day in 3 of the most common hospital workshifts:1 (11:00pm-6:59am), 2 (7am-2:59pm) and
3: (3:00pm-10:59pm). 
Acuity level: 1 (Weak), 2 & 3(Mild), 4 & 5 (severe)
TypeofDay: 1 (Weekend) and 0(Weekdays). 


```{r, warning=FALSE, message=FALSE}
ggplot(emergency.data, aes(x=age, y=los, group=interaction(acuitylevels, typeofday), colour=acuitylevels, linetype=factor(typeofday))) +
geom_smooth(size=1, alpha=0.2) + 
xlab("Age") + ylab('length of stay') + 
ggtitle('Figure 1')  + 
scale_linetype_manual('typeofday', values=c(1,2,3)) + 
theme_bw() + 
theme(axis.text.y=element_text(angle=90, hjust=0.5), plot.margin=rep(unit(0,"null"),4), legend.position='bottom', legend.box='vertical', text=element_text(size=9), legend.text=element_text(size=6)) + scale_x_continuous(breaks=seq(18,85,10))
```
As you can see in the code above, aes() gives us the x and y variables, and I introduced additional variables that will interact, acuity levels has three distinct colors ( red, green and blue) and if you look closely typeofday show us that lines that are dotted represent 1, and lines that are continuous are 0.
Patients with acuity levels represented as mild (red), tend to have a higher length of stay during weekdays        (continuous line that represent 0: Weekdays).

geom_smooth : smoothing method (function) to use, eg. lm, glm, gam, loess, rlm. For datasets with n < 1000 default is loess. For datasets with 1000 or more observations defaults to gam. Here the default was gam.
In case you have a scatterplot with a lot of noise, seeing dominant pattern can be taxing. In this case adding a smoothed line to the plot with geom_smooth() would be greatly beneficial.

scale_x_continuous() here is giving limits of age range: from 18 to 85 with increments of 10.


### Example 2:
```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(grid)
library(dplyr)
library(boot)
library(gridExtra)
library(xtable)

load("/Users/ckineza/Desktop/My Life /Everything/nmes.rdata")
dat <- nmes
dat$mscd <- (dat$lc5==1) | (dat$chd5==1)
dat$noexp <- (dat$totalexp == 0)
dat$RACE3 <- factor(dat$RACE3, levels=c(1,2,3), labels=c('white','black','other'))
dat$highincome <- ifelse(dat$povstalb=='.',NA,dat$povstalb==5)
dat$raceother <- (dat$RACE3=='other')


dat$age_m40 <- (dat$lastage - 40)
dat$age_m40c <- (dat$age_m40)^3
dat$age_csp <- (ifelse(dat$lastage>60, dat$lastage-60, 0))^3
fit1a <- glm(noexp ~ (mscd + male)*(age_m40 + age_m40c + age_csp) + mscd*male + raceother + highincome, data=dat, family='binomial')
fit1b <- glm(noexp ~ (mscd + male)*age_m40 + mscd*male + raceother + highincome, data=dat, family='binomial')
fit1c <- glm(noexp ~ (mscd + male)*(age_m40 + age_m40c + age_csp) + raceother + highincome, data=dat, family='binomial')
#Test interactions
fit1d <- glm(noexp ~ male + mscd + (age_m40 + age_m40c + age_csp) + raceother + highincome, data=dat, family='binomial') 
fit.final <- glm(noexp ~ male + mscd + (age_m40 + age_m40c + age_csp) + raceother + highincome, data=dat, family='binomial')  


fit1 <- fit1d

dat_age <- subset(dat, !raceother & !highincome)
dat_age$age_decile <- ntile(dat_age$lastage, 10)
dat_age <- summarise(group_by(dat_age, mscd, male, age_decile, raceother, highincome), age=median(lastage), p = mean(noexp), odds = p/(1-p))
dat_age$age_m40 <- dat_age$age - 40
dat_age$age_m40c <- (dat_age$age_m40)^3
dat_age$age_csp <- (ifelse(dat_age$age_m40>20, dat_age$age_m40-20, 0))^3
dat_age$fittedvals <- predict(fit1, newdata=dat_age, type='response')


fit1 <- glm(noexp ~ male + mscd + (age_m40 + age_m40c + age_csp) + raceother + highincome, data=dat, family='binomial') 
```

Below is a plot that illustrates the fraction of total medical expenditures that are attributable to having a major smoking-caused disease (MSCD) --- including lung cancer, laryngeal cancer, COPD, CHD, stroke, and other cancers --- for different age, sex and demographic strata. The data comes from the National Medical Expenditure Survey (NMES)

```{r, message=FALSE,cache=FALSE}
ggplot(dat, aes(x=lastage, y=noexp, group=interaction(mscd, male), colour=mscd, linetype=factor(male))) + geom_jitter(size=0.5) + 
xlab("Age") + 
ylab('Zero Expenditures') + 
geom_smooth(size=1.1, alpha=0.5) + 
ggtitle('Figure 2') + 
  
scale_linetype_manual('Male', values=c(1,3)) + 
theme_bw() + 
theme(axis.text.y=element_text(angle=90, hjust=0.5), plot.margin=rep(unit(0,"null"),4), legend.position='bottom', legend.box='horizontal', text=element_text(size=9), legend.text=element_text(size=6)) + scale_x_continuous(breaks=seq(40,80,10))
```

Lastly, a quick illustration of facet_wrap using the mpg data which is one of the R default data.
```{r,warning=FALSE, message=FALSE} 
data('mtcars')
ggplot(mpg, aes(displ, hwy)) + 
  ggtitle('Figure 3') +
  geom_point() +
  facet_wrap(~class, nrow = 4)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}

# load("/Users/ckineza/Desktop/My Life /Everything/nmes.rdata")
# #look at subjects 40 and older
# Data=nmes[nmes$lastage>=40,]
# #create a binary MSCD variable
# Data$disease=(Data$lc5+Data$chd5)>0
# Data$povstalb <- as.factor(Data$povstalb) 
# Data$educate <- as.factor(Data$educate)
# Data$chd5 <- as.character(Data$chd5)
# Data$chd5[Data$chd5 == "."] <- NA
# Data$male <- as.character(Data$male)
# Data$male[Data$male == "."] <- NA
# Data$povstalb <- as.character(Data$povstalb)
# Data$povstalb[Data$povstalb == "."] <- NA
# Data$educate <- as.character(Data$educate)
# Data$educate[Data$educate == "."] <- NA
# Data$disease <- as.character(Data$ disease)
# Data$disease[Data$disease == "."] <- NA
# new_DF <- Data[is.na(Data$povstalb),] # Check for NA's
# #Remove the Na's
# Data <- Data[complete.cases(Data), ]
# Data$age.quintiled <- as.numeric(cut_number(Data$lastage,5))
# Data$totalexp_trim = ifelse(Data$totalexp<20000, Data$totalexp,20000)
# table(Data$totalexp >0, Data$disease)
# ggplot(Data,aes(factor(age.quintiled),totalexp)) +
# geom_boxplot(aes(fill=factor(disease))) + facet_grid(.~ povstalb,scales = "fixed")
# ggplot(Data,aes( x= lastage,totalexp_trim,colour=factor(disease))) +
#   geom_jitter(alpha=0.4) + geom_smooth(method ="lm") + facet_grid(.~povstalb, scales ="fixed")
# 

```
I hope you enjoyed this little tutorial about ggplot2!
